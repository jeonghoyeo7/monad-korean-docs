# 병렬 실행 (Parallel Execution)

모나드는 트랜잭션을 병렬로 실행합니다. 처음에는 이것이 이더리움과 다른 실행 의미를 암시하는 것처럼 보일 수 있지만 실제로는 그렇지 않습니다. 모나드 블록은 이더리움 블록과 동일합니다 - 선형으로 정렬된 트랜잭션 집합입니다. 블록의 트랜잭션을 실행한 결과는 모나드와 이더리움 사이에 동일합니다.

#### 낙관적 실행 (Optimistic Execution)

기본적으로 모나드는 낙관적 실행을 사용합니다. 이는 모나드가 블록의 이전 트랜잭션이 완료되기 전에 트랜잭션 실행을 시작한다는 것을 의미합니다. 때때로 (하지만 항상 그런 것은 아닙니다) 이로 인해 잘못된 실행이 발생합니다.

다음 두 가지 트랜잭션(이 순서로 블록에 포함됨)을 고려해 보세요:

1. 트랜잭션 1은 계정 A의 잔액을 읽고 업데이트합니다 (예: 계정 B에서 전송받음).
2. 트랜잭션 2도 계정 A의 잔액을 읽고 업데이트합니다 (예: 계정 C로 전송).

이 트랜잭션이 병렬로 실행되고 트랜잭션 2가 트랜잭션 1이 완료되기 전에 실행되기 시작하면, 트랜잭션 2가 계정 A에 대해 읽는 잔액은 순차적으로 실행된 경우와 다를 수 있습니다. 이는 잘못된 실행 결과를 초래할 수 있습니다.

낙관적 실행이 이를 해결하는 방법은 트랜잭션 2를 실행하는 동안 사용된 입력을 추적하고 이를 트랜잭션 1의 출력과 비교하는 것입니다. 다르면, 트랜잭션 2가 실행 중에 잘못된 데이터를 사용했음을 감지하고 올바른 데이터로 다시 실행해야 합니다.

모나드는 트랜잭션을 병렬로 실행하지만, 각 트랜잭션에 대한 업데이트된 상태는 위에서 언급한 조건을 확인하기 위해 순차적으로 "병합"됩니다.

관련된 컴퓨터 과학 주제는 [낙관적 동시성 제어](https://en.wikipedia.org/wiki/Optimistic_concurrency_control) (OCC) 및 [소프트웨어 트랜잭셔널 메모리](https://en.wikipedia.org/wiki/Software_transactional_memory) (STM)입니다.

#### 낙관적 실행의 의미

낙관적 실행의 단순 구현에서는 블록의 이전 트랜잭션이 완료될 때까지 트랜잭션을 다시 실행해야 한다는 사실을 감지하지 않습니다. 그때는 모든 이전 트랜잭션의 상태 업데이트가 병합되므로, 낙관적 실행으로 인해 트랜잭션이 두 번째로 실패할 가능성은 없습니다.

트랜잭션 실행 단계에는 상태에 의존하지 않는 단계가 있습니다. 예를 들어 서명 복구는 비용이 많이 드는 계산입니다. 트랜잭션을 다시 실행할 때 이 작업을 반복할 필요는 없습니다.

또한 병합 실패로 인해 트랜잭션을 다시 실행할 때, 종종 접근하는 계정 및 저장소는 변경되지 않습니다. 이 상태는 여전히 메모리에 캐시되므로, 이 역시 반복할 필요가 없는 비용이 많이 드는 작업입니다.

#### 스케줄링

낙관적 실행의 단순 구현은 프로세서에 사용 가능한 리소스가 있을 때 다음 트랜잭션을 실행하려고 합니다. 블록 내에서 서로 의존하는 긴 "체인"의 트랜잭션이 있을 수 있습니다. 이러한 트랜잭션을 병렬로 실행하면 상당수의 실패가 발생할 수 있습니다.

사전 트랜잭션 간의 종속성을 미리 결정하면 모나드는 선행 트랜잭션이 완료되었을 때만 트랜잭션을 실행하도록 예약하여 이러한 낭비된 노력을 피할 수 있습니다. 모나드에는 이러한 예측을 시도하는 정적 코드 분석기가 있습니다. 최상의 경우 모나드는 많은 종속성을 미리 예측할 수 있으며, 최악의 경우 모나드는 단순 구현으로 되돌아갑니다.

#### 앞으로의 연구

여전히 탐구 중인 트랜잭션을 다시 실행하지 않기 위한 다른 후보들이 있습니다.