# 비동기 실행 (Asynchronous Execution)

원래는 지연 실행(Deferred Execution)으로 불렸던 부분이지만, 최근에는 비동기 실행(Asynchronous Execution)으로 더 많이 참조되는 부분입니다.

## 파이프라인된 합의-실행 스테이징

모나드 블록체인의 새로운 측면 중 하나는 실행이 합의와 분리된다는 점입니다.

합의는 모나드 노드가 트랜잭션의 공식 순서에 대해 합의하는 과정이고, 실행은 실제로 그 트랜잭션을 실행하고 상태를 업데이트하는 과정입니다.

모나드 합의에서는 노드가 트랜잭션의 공식 순서에 대해 합의하지만, 리더나 검증 노드가 아직 그 트랜잭션을 실행하지 않았습니다.

즉, 리더는 결과 상태 루트를 알지 못한 채 순서를 제안하고, 검증 노드는 블록 유효성에 대해 투표하지만 블록의 모든 트랜잭션이 성공적으로 실행되는지 여부를 알지 못한 채 투표합니다.

어떻게 이런 일이 가능할까요? 그리고 모나드는 왜 이렇게 할까요?

이 답변은 모나드의 설계의 핵심이며, 단일 샤드 블록체인이 수백만 명의 사용자에게 확장될 수 있도록 하는 중요한 속도를 제공할 수 있습니다.

## 실행과 합의가 번갈아가며 나오는 것은 비효율적

이더리움에서는 실행이 합의의 전제 조건입니다. 따라서 노드가 블록에 대한 합의를 이룰 때 블록의 트랜잭션 목록과 해당 트랜잭션 목록을 실행한 후의 모든 상태를 요약하는 머클 루트에 대해 동의합니다. 결과적으로 리더는 제안을 공유하기 전에 제안된 블록의 모든 트랜잭션을 실행해야 하며, 검증 노드는 투표하기 전에 그 트랜잭션을 실행해야 합니다.

이 패러다임에서는 실행 시간 예산이 매우 제한적입니다. 실행이 합의를 차단하기 때문에 가스 한도는 모든 노드에서 예산 내에 완료되도록 극히 보수적으로 선택해야 합니다.

## 트랜잭션 순서를 결정하는 것은 스테이트 결과를 결정하는 것과 같다

다음은 명백하지만 중요한 통찰입니다. 트랜잭션의 공식 순서가 주어지면 실제 상태는 완전히 결정됩니다. 실행은 진실을 밝히기 위해 필요하지만 진실은 이미 결정되어 있습니다.

모나드는 노드가 합의 전에 실행을 할 필요가 없다는 통찰력을 활용합니다. 노드 합의는 공식 순서에 대한 것입니다. 각 노드는 블록 `N`의 트랜잭션을 독립적으로 실행하면서 블록 `N+1`에 대한 합의를 시작합니다.

이는 전체 블록 시간에 해당하는 가스 예산을 허용합니다. 실행은 단지 합의와 함께 진행되면 됩니다. 또한 이 접근 방식은 실행이 평균적으로 합의에 따라 진행되기만 하면 되므로 정확한 계산 시간의 변동에 더 관대합니다.

## 머클루트가 지연되더라도 스테이트 머신 복제는 유지된다

여기에 대한 주요 이의는 다음과 같습니다:

1. 노드 중 하나가 악의적이라면 어떻게 될까요? (예: 특정 트랜잭션을 생략하거나 상태 변수를 임의의 값으로 설정)
2. 노드 중 하나가 실행 중 실수를 하면 어떻게 될까요?

이러한 문제를 해결하기 위해, 모나드 블록 제안에는 `D` 블록만큼 지연된 머클 루트가 포함됩니다. 이로 인해:

1. 네트워크가 블록 `N`에 대한 합의를 이루면, 이는 네트워크가 블록 `N-D`의 공식 결과가 머클 루트 `M`에 뿌리를 둔 상태라는 데 동의했음을 의미합니다.
2. 블록 `N-D`에서 실행 오류가 있는 노드는 블록 `N`에서 합의에서 제외됩니다. 이는 해당 노드가 블록 `N-D-1`의 끝 상태로 롤백한 다음 블록 `N-D`의 트랜잭션을 다시 실행하도록 트리거됩니다.

이더리움의 접근 방식은 합의를 통해 상태 기계 복제를 매우 엄격하게 시행합니다. 그러나 모나드는 엄격함을 약간 완화하여 큰 효과를 얻습니다.

## 최종성(Finality)

모나드BFT에서 최종성은 단일 슬롯(1초)이며, 실행 결과는 일반적으로 전체 노드를 사용하는 경우 1초 미만으로 지연됩니다.

### 모나드의 최종성

모나드에서 최종성은 단일 슬롯(1초)입니다. 트랜잭션을 제출하면 단일 블록 후에 트랜잭션의 공식 순서를 확인할 수 있습니다. 이는 이더리움(2 에포크, 약 12.8분)보다 훨씬 빠릅니다.

### 실행 결과

트랜잭션의 실행 결과(성공 여부, 이후 잔액)는 일반적으로 전체 노드에서 1초 미만으로 지연됩니다. 트랜잭션 결과를 빠르게 알아야 하는 사람(예: 주문 상태를 알고 싶은 고빈도 트레이더)은 전체 노드를 실행할 수 있습니다.

전체 노드를 실행하지 않고 트랜잭션 결과를 안전하게 조회하려는 사람은 라이트 클라이언트를 실행하면서 전체 노드에 머클 증명으로 잔액을 조회할 수 있습니다. 이 경우 쿼리는 머클 루트 지연(`D=10` 블록, 즉 10초)만큼 지연됩니다. 대부분의 사용자는 소프트웨어 지갑 또는 블록 탐색기를 통해 블록체인의 상태를 조회합니다.

일부 독자는 머클 루트 지연(`D=10` 블록)을 최종성과 혼동하여 최종성이 10 블록이라고 잘못 가정할 수 있습니다. 이는 사실이 아닙니다. 공식 트랜잭션 순서는 1 블록 후에 결정되며, 초다수의 비잔틴 행동이 없는 한 다시 정렬되지 않습니다.
